<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque Geral</title>
    <!-- Carregando o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importando ícones para a UI -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    
    <!-- Configurações de Fonte e Estilo -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Números tabulares para alinhamento perfeito */
        .font-mono-numbers {
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }

        /* Scrollbar personalizada mais sutil */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Estilos de Impressão */
        @media print {
            body > * { display: none; }
            #receipt-modal, #receipt-modal-content {
                display: block !important;
                visibility: visible !important;
                position: absolute;
                left: 0; top: 0; width: 100%; height: auto;
                background: white; box-shadow: none; border: none;
            }
            #receipt-modal-content {
                width: 100% !important; max-width: 100% !important;
                transform: none !important; opacity: 1 !important;
            }
            .no-print { display: none !important; }
        }
        
        /* Animações */
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

    <!-- Imports do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, updateDoc, addDoc, collection, query, where, getDocs, 
            onSnapshot, serverTimestamp, writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variáveis Globais ---
        let db, auth, userId, appId;
        let isAuthReady = false;
        let unsubscribeItems = () => {};
        let unsubscribeHistory = () => {};

        // --- Configuração do Firebase ---
        async function setupFirebase() {
            try {
                const firebaseConfigJson = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                const firebaseConfig = JSON.parse(firebaseConfigJson);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (!firebaseConfig.apiKey) {
                    console.warn("Configuração do Firebase não encontrada. Modo Offline.");
                    showNotification("Modo Offline ativado.", "warning");
                    state.allItems = seedData.items;
                    state.withdrawalHistory = [];
                    isAuthReady = true;
                    render(); // Chama a função global render
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        await checkAndSeedDatabase(); 
                        setupFirestoreListeners(); 
                        render(); // Chama a função global render após login
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Erro Firebase:", error);
                showNotification("Erro de conexão.", "error");
            }
        }
        
        async function checkAndSeedDatabase() {
            if (!isAuthReady || !db) return;
            const itemsRef = collection(db, "artifacts", appId, "users", userId, "general_stock");
            const q = query(itemsRef, where("appId", "==", appId));
            
            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    const batch = writeBatch(db);
                    seedData.items.forEach(item => {
                        const docRef = doc(db, "artifacts", appId, "users", userId, "general_stock", item.codigo);
                        batch.set(docRef, { ...item, appId: appId }); 
                    });
                    await batch.commit();
                }
            } catch (error) { console.error(error); }
        }

        function setupFirestoreListeners() {
            if (!isAuthReady || !db) return;
            
            unsubscribeItems(); 
            const itemsRef = collection(db, "artifacts", appId, "users", userId, "general_stock");
            
            unsubscribeItems = onSnapshot(itemsRef, (snapshot) => {
                const items = [];
                snapshot.forEach(doc => items.push({ ...doc.data(), firestoreId: doc.id }));
                state.allItems = items;
                renderItemList(); 
                renderItemDetails();
            });

            unsubscribeHistory();
            const historyRef = collection(db, "artifacts", appId, "users", userId, "general_history");
            
            unsubscribeHistory = onSnapshot(historyRef, (snapshot) => {
                const history = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    history.push({ 
                        ...data, 
                        firestoreId: doc.id,
                        date: data.date ? data.date.toDate() : new Date(),
                        tipoRetirada: data.tipoRetirada || 'Consumo',
                        centroCusto: data.centroCusto || 'N/A',
                        setor: data.setor || 'N/A',
                        dataDevolucao: data.dataDevolucao || null,
                        outroSetor: data.outroSetor || false
                    });
                });
                state.withdrawalHistory = history;
                if(state.currentWarehouse === 'relatorio') renderReport();
            });
        }
        
        // --- FUNÇÕES AUXILIARES ---

        function safeMath(value) {
            return Math.round((value + Number.EPSILON) * 100) / 100;
        }

        function formatStock(stockObj) {
            if (!stockObj || stockObj.value === undefined) return "N/D";
            const val = safeMath(stockObj.value);
            return `${val} ${stockObj.unit}`;
        }

        const seedData = {
            items: [
                { warehouse: 'marketing', codigo: 'MKT1', descricao: 'Banner Roll-Up (Grande)', formato: 'Unidade', localizacao: 'MKT.A1', bloco: 'A', estoque: { value: 5, unit: 'un' }, status: 'OK' },
                { warehouse: 'marketing', codigo: 'MKT2', descricao: 'Caixa de Canetas', formato: 'Caixa', localizacao: 'MKT.A2', bloco: 'A', estoque: { value: 20, unit: 'cx' }, status: 'OK' },
                { warehouse: 'rh', codigo: 'RH1', descricao: 'Kit Boas-Vindas', formato: 'Kit', localizacao: 'RH.B1', bloco: 'B', estoque: { value: 15, unit: 'kits' }, status: 'OK' },
                { warehouse: 'lacteos', codigo: 'LAC1', descricao: 'Forma Queijo', formato: 'Unidade', localizacao: 'LAC.C1', bloco: 'C', estoque: { value: 30, unit: 'un' }, status: 'OK' }
            ]
        };
        
        const state = {
            currentWarehouse: 'marketing',
            selectedItemCode: null, 
            searchTerm: '',
            allItems: [],
            withdrawalHistory: []
        };

        // --- RENDERIZAÇÃO ---
        
        // Função Global de Renderização (Adicionada para corrigir o ReferenceError)
        function render() {
            if (state.currentWarehouse === 'relatorio') {
                renderReport();
            } else {
                renderItemList();
                renderItemDetails();
            }
        }
        
        function renderItemList() {
            const itemListEl = document.getElementById('item-list');
            if (!isAuthReady) {
                itemListEl.innerHTML = '<p class="p-4 text-gray-500 text-center animate-pulse">Carregando dados...</p>';
                return;
            }
            
            const items = state.allItems.filter(item => item.warehouse === state.currentWarehouse);
            itemListEl.innerHTML = ''; 

            const filteredItems = items.filter(item => {
                const term = state.searchTerm.toLowerCase();
                if (!term) return true; 
                return item.descricao.toLowerCase().includes(term) || item.codigo.toLowerCase().includes(term);
            });

            if (filteredItems.length === 0) {
                itemListEl.innerHTML = '<div class="p-8 text-center text-gray-400"><ion-icon name="search" class="text-4xl mb-2"></ion-icon><p>Nenhum item encontrado.</p></div>';
                return;
            }

            filteredItems.sort((a, b) => a.descricao.localeCompare(b.descricao));

            filteredItems.forEach(item => {
                const isSelected = item.codigo === state.selectedItemCode;
                const status = item.status || 'N/A';
                
                const div = document.createElement('div');
                div.className = `group flex justify-between items-center p-4 border-b border-gray-100 cursor-pointer transition-all duration-200 ${isSelected ? 'bg-blue-50 border-l-4 border-l-blue-600' : 'hover:bg-gray-50 border-l-4 border-l-transparent'}`;
                div.onclick = () => {
                    state.selectedItemCode = item.codigo;
                    renderItemList();
                    renderItemDetails();
                };

                div.innerHTML = `
                    <div class="flex-grow overflow-hidden mr-3">
                        <p class="text-sm font-semibold text-gray-800 truncate group-hover:text-blue-700 transition-colors">${item.descricao}</p>
                        <p class="text-xs text-gray-500 font-mono mt-0.5">Ref: ${item.codigo}</p>
                    </div>
                    ${renderStatusBadge(status)}
                `;
                itemListEl.appendChild(div);
            });
        }

        function renderItemDetails() {
            const itemDetailsEl = document.getElementById('item-details');
            
            if (!state.selectedItemCode) {
                itemDetailsEl.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-300">
                        <div class="bg-gray-50 p-6 rounded-full mb-4">
                            <ion-icon name="cube-outline" class="text-6xl"></ion-icon>
                        </div>
                        <p class="text-lg font-medium text-gray-500">Selecione um item para ver os detalhes</p>
                        <p class="text-sm">Use a lista à esquerda para navegar</p>
                    </div>`;
                return;
            }

            const item = state.allItems.find(i => i.codigo === state.selectedItemCode && i.warehouse === state.currentWarehouse);

            if (!item) {
                state.selectedItemCode = null;
                renderItemDetails();
                return;
            }

            // Cards de detalhes
            const detailCard = (label, value, icon) => `
                <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center space-x-3 hover:shadow-md transition-shadow">
                    <div class="bg-blue-50 p-2 rounded-lg text-blue-600">
                        <ion-icon name="${icon}" class="text-xl"></ion-icon>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold tracking-wide">${label}</p>
                        <p class="text-gray-900 font-semibold text-sm">${value || '-'}</p>
                    </div>
                </div>
            `;

            itemDetailsEl.innerHTML = `
                <div class="animate-fade-in flex flex-col h-full">
                    <!-- Cabeçalho do Item -->
                    <div class="flex justify-between items-start mb-6 pb-4 border-b border-gray-100">
                        <div>
                            <span class="inline-block px-2 py-1 bg-gray-100 text-gray-600 text-[10px] font-bold uppercase rounded mb-2 tracking-wider">Código: ${item.codigo}</span>
                            <h2 class="text-2xl font-bold text-gray-800 leading-tight">${item.descricao}</h2>
                        </div>
                        <button onclick="window.handleShowWithdrawModal('${item.codigo}')" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-semibold shadow-lg shadow-blue-200 flex items-center transition-all active:scale-95 hover:-translate-y-0.5">
                            <ion-icon name="remove-circle-outline" class="mr-2 text-xl"></ion-icon>
                            Retirar
                        </button>
                    </div>

                    <!-- Grid de Informações -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        ${detailCard('Localização', item.localizacao, 'location-outline')}
                        ${detailCard('Bloco/Corredor', item.bloco, 'grid-outline')}
                        ${detailCard('Formato', item.formato, 'shapes-outline')}
                    </div>

                    <!-- Card de Estoque Principal -->
                    <div class="bg-gradient-to-br from-gray-50 to-white p-8 rounded-2xl border border-gray-200 flex items-center justify-between shadow-sm relative overflow-hidden mt-auto mb-4">
                        <div class="relative z-10">
                            <p class="text-sm font-bold text-gray-500 uppercase mb-1 tracking-wider">Estoque Disponível</p>
                            <div class="flex items-baseline space-x-2">
                                <p class="text-6xl font-bold text-gray-900 font-mono-numbers tracking-tight">
                                    ${formatStock(item.estoque).split(' ')[0]}
                                </p>
                                <span class="text-xl font-medium text-gray-500">${item.estoque.unit}</span>
                            </div>
                        </div>
                        <div class="text-right relative z-10">
                            <div class="mb-2">
                                <p class="text-xs font-bold text-gray-400 uppercase mb-1">Status Atual</p>
                                ${renderStatusBadge(item.status, true)}
                            </div>
                        </div>
                        <!-- Decoração de fundo -->
                        <ion-icon name="bar-chart-outline" class="absolute -right-6 -bottom-6 text-9xl text-gray-100 z-0"></ion-icon>
                    </div>
                </div>
            `;
        }
        
        function renderReport() {
            const tbody = document.getElementById('withdrawal-history-table-body');
            tbody.innerHTML = ''; 

            if (state.withdrawalHistory.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center p-12 text-gray-400">Nenhum registro encontrado no histórico.</td></tr>`;
                return;
            }

            const sortedHistory = [...state.withdrawalHistory].sort((a, b) => b.date - a.date);

            sortedHistory.forEach(entry => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-50 hover:bg-blue-50/50 transition-colors group';
                
                const tipoConfig = entry.tipoRetirada === 'emprestimo' 
                    ? { class: 'bg-purple-100 text-purple-700', label: 'Empréstimo' }
                    : { class: 'bg-green-100 text-green-700', label: 'Consumo' };

                const devDisplay = entry.dataDevolucao 
                    ? `<div class="flex items-center text-xs text-red-600 font-semibold mt-1 bg-red-50 w-fit px-1.5 py-0.5 rounded border border-red-100"><ion-icon name="calendar-outline" class="mr-1"></ion-icon> Dev: ${entry.dataDevolucao}</div>` 
                    : '';
                
                const setorDisplay = entry.outroSetor 
                    ? `<span class="font-semibold text-gray-700">${entry.setor}</span> <span class="text-gray-400 mx-1">•</span> <span class="text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">${entry.centroCusto}</span>` 
                    : '<span class="text-gray-500 italic">Interno</span>';
                
                row.innerHTML = `
                    <td class="px-6 py-4 text-gray-500 text-sm whitespace-nowrap">
                        ${entry.date.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-semibold text-gray-900">${entry.requester}</div>
                        <div class="text-xs mt-1 flex items-center">${setorDisplay}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-700 font-medium">${entry.itemName}</td>
                    <td class="px-6 py-4">
                        <span class="${tipoConfig.class} px-2.5 py-1 rounded-full text-xs font-bold inline-block shadow-sm">${tipoConfig.label}</span>
                        ${devDisplay}
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-base font-bold text-gray-900 font-mono-numbers">${safeMath(entry.amount)}</span> 
                        <span class="text-xs text-gray-500 font-medium">${entry.unit}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderStatusBadge(status, large = false) {
            let config = { color: 'bg-gray-100 text-gray-600 border-gray-200', icon: 'ellipse' };
            
            if (status === 'OK') config = { color: 'bg-green-50 text-green-700 border-green-200', icon: 'checkmark-circle' };
            if (status === 'Baixo') config = { color: 'bg-yellow-50 text-yellow-700 border-yellow-200', icon: 'alert-circle' };
            if (status === 'Crítico') config = { color: 'bg-red-50 text-red-700 border-red-200', icon: 'warning' };
            
            const size = large ? 'px-4 py-1.5 text-sm' : 'px-2.5 py-0.5 text-[10px]';
            
            return `<span class="${size} rounded-full font-bold ${config.color} border inline-flex items-center shadow-sm">
                <ion-icon name="${config.icon}" class="${large ? 'mr-2 text-lg' : 'mr-1'}"></ion-icon> ${status}
            </span>`;
        }

        function showNotification(msg, type = 'info') {
            const container = document.getElementById('notification-container');
            const colors = { info: 'bg-blue-600', success: 'bg-green-600', warning: 'bg-yellow-600', error: 'bg-red-600' };
            
            const div = document.createElement('div');
            div.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-xl mb-3 flex items-center animate-fade-in text-sm font-medium backdrop-blur-sm bg-opacity-95 transform transition-all hover:scale-[1.02] cursor-pointer`;
            div.innerHTML = `<ion-icon name="notifications" class="mr-3 text-xl opacity-80"></ion-icon> ${msg}`;
            
            div.onclick = () => div.remove();
            container.appendChild(div);
            setTimeout(() => {
                div.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => div.remove(), 300);
            }, 4000);
        }

        // --- LÓGICA DE RETIRADA (Mantida e Organizada) ---

        window.handleShowWithdrawModal = (codigo) => {
            const item = state.allItems.find(i => i.codigo === codigo && i.warehouse === state.currentWarehouse);
            if (!item) return;

            // Reset
            document.getElementById('withdraw-stock-form').reset();
            document.getElementById('campos-outro-setor').classList.add('hidden');
            document.getElementById('campo-devolucao').classList.add('hidden');
            
            // Set
            document.getElementById('withdraw-item-codigo').value = codigo;
            document.getElementById('withdraw-item-name').textContent = item.descricao;
            document.getElementById('withdraw-current-stock').textContent = formatStock(item.estoque);
            document.getElementById('withdraw-unit-label').textContent = item.estoque.unit;

            // Show
            const modal = document.getElementById('withdraw-stock-modal');
            const content = document.getElementById('withdraw-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
            document.getElementById('withdraw-name').focus();
        };

        window.closeWithdrawModal = () => {
            const modal = document.getElementById('withdraw-stock-modal');
            const content = document.getElementById('withdraw-modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        };

        window.handleSubmitWithdraw = async (e) => {
            e.preventDefault();
            if (!isAuthReady) return;

            const codigo = document.getElementById('withdraw-item-codigo').value;
            const nome = document.getElementById('withdraw-name').value;
            let qtd = parseFloat(document.getElementById('withdraw-amount').value);
            qtd = safeMath(qtd);

            if (!nome || isNaN(qtd) || qtd <= 0) {
                showNotification("Verifique os dados preenchidos.", "error");
                return;
            }

            const item = state.allItems.find(i => i.codigo === codigo && i.warehouse === state.currentWarehouse);
            const checkOutroSetor = document.getElementById('withdraw-outro-setor').checked;
            const checkEmprestimo = document.getElementById('withdraw-emprestimo').checked;
            
            const centroCusto = document.getElementById('withdraw-centro-custo').value;
            const setor = document.getElementById('withdraw-setor').value;
            const dataDev = document.getElementById('withdraw-data-devolucao').value;

            if (checkOutroSetor && (!centroCusto || !setor)) {
                showNotification("Setor e Centro de Custo são obrigatórios.", "error");
                return;
            }
            if (checkEmprestimo && !dataDev) {
                showNotification("Data de devolução obrigatória.", "error");
                return;
            }

            if (qtd > item.estoque.value) {
                showNotification(`Estoque insuficiente. Disponível: ${item.estoque.value}`, "error");
                return;
            }

            try {
                let novoEstoque = item.estoque.value;
                if (!checkEmprestimo) {
                    novoEstoque = safeMath(item.estoque.value - qtd);
                    const itemRef = doc(db, "artifacts", appId, "users", userId, "general_stock", codigo);
                    await updateDoc(itemRef, { "estoque.value": novoEstoque });
                }

                const historyRef = collection(db, "artifacts", appId, "users", userId, "general_history");
                await addDoc(historyRef, {
                    date: serverTimestamp(),
                    requester: nome,
                    itemName: item.descricao,
                    amount: qtd,
                    unit: item.estoque.unit,
                    tipoRetirada: checkEmprestimo ? 'emprestimo' : 'consumo',
                    outroSetor: checkOutroSetor,
                    centroCusto: checkOutroSetor ? centroCusto : 'Interno',
                    setor: checkOutroSetor ? setor : 'Interno',
                    dataDevolucao: dataDev ? dataDev.split('-').reverse().join('/') : null
                });

                window.closeWithdrawModal();
                showReceipt(nome, item, qtd, novoEstoque, checkEmprestimo, checkOutroSetor, setor, centroCusto, dataDev);
                showNotification("Sucesso! Retirada registrada.", "success");

            } catch (err) {
                console.error(err);
                showNotification("Erro no sistema. Tente novamente.", "error");
            }
        };

        // --- COMPROVANTE ---

        function showReceipt(nome, item, qtd, resto, isEmp, isOutro, setor, cc, dataDev) {
            document.getElementById('receipt-date').textContent = new Date().toLocaleString('pt-BR');
            document.getElementById('receipt-requester').textContent = nome;
            document.getElementById('receipt-item').textContent = `${item.codigo} - ${item.descricao}`;
            document.getElementById('receipt-qtd').textContent = `${safeMath(qtd)} ${item.estoque.unit}`;
            document.getElementById('receipt-rest').textContent = `${safeMath(resto)} ${item.estoque.unit}`;
            document.getElementById('receipt-type').textContent = isEmp ? 'EMPRÉSTIMO' : 'CONSUMO';
            
            const extraInfo = document.getElementById('receipt-extra');
            let htmlExtra = '';
            if (isOutro) htmlExtra += `<div class="flex justify-between text-xs mt-1 bg-gray-50 p-1 rounded"><dt>Destino:</dt><dd>${setor} (${cc})</dd></div>`;
            if (isEmp) htmlExtra += `<div class="flex justify-between font-bold text-red-600 mt-2 pt-2 border-t border-dashed border-red-200"><dt>Devolução até:</dt><dd>${dataDev.split('-').reverse().join('/')}</dd></div>`;
            extraInfo.innerHTML = htmlExtra;

            const modal = document.getElementById('receipt-modal');
            const content = document.getElementById('receipt-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        window.closeReceipt = () => {
            document.getElementById('receipt-modal').classList.add('hidden');
        };
        
        // --- INICIALIZAÇÃO E EVENTOS ---

        document.addEventListener('DOMContentLoaded', () => {
            // Abas
            const tabs = document.querySelectorAll('.warehouse-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => {
                        t.className = 'warehouse-tab text-gray-500 hover:text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap cursor-pointer';
                    });
                    tab.className = 'warehouse-tab bg-white text-blue-700 shadow-sm border border-gray-100 px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap cursor-pointer';
                    
                    state.currentWarehouse = tab.dataset.warehouse;
                    state.selectedItemCode = null;
                    state.searchTerm = '';
                    document.getElementById('search-bar').value = '';
                    
                    if (state.currentWarehouse === 'relatorio') {
                        document.getElementById('main-content').classList.add('hidden');
                        document.getElementById('report-area').classList.remove('hidden');
                        renderReport();
                    } else {
                        document.getElementById('main-content').classList.remove('hidden');
                        document.getElementById('report-area').classList.add('hidden');
                        renderItemList();
                        renderItemDetails();
                    }
                });
            });

            // Busca
            document.getElementById('search-bar').addEventListener('input', (e) => {
                state.searchTerm = e.target.value;
                renderItemList();
            });

            // Toggle Campos Modal
            document.getElementById('withdraw-outro-setor').addEventListener('change', (e) => {
                const el = document.getElementById('campos-outro-setor');
                if (e.target.checked) el.classList.remove('hidden'); else el.classList.add('hidden');
            });
            document.getElementById('withdraw-emprestimo').addEventListener('change', (e) => {
                const el = document.getElementById('campo-devolucao');
                if (e.target.checked) el.classList.remove('hidden'); else el.classList.add('hidden');
            });
            
            // Toggle Ajuda
            document.getElementById('help-toggle').addEventListener('click', () => {
                const content = document.getElementById('help-content');
                const icon = document.querySelector('#help-toggle ion-icon[name="chevron-down-outline"]');
                content.classList.toggle('hidden');
                icon.style.transform = content.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
            });

            setupFirebase();
        });

    </script>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden selection:bg-blue-100 selection:text-blue-900">

    <!-- CABEÇALHO -->
    <header class="bg-white shadow-sm z-20 h-20 flex-shrink-0 border-b border-gray-100 relative">
        <div class="container mx-auto px-6 h-full flex justify-between items-center">
            <div class="flex items-center">
                <a href='https://postimg.cc/qgvMZTFh' target='_blank' class="mr-5 transition-opacity hover:opacity-80">
                    <img src='https://i.postimg.cc/MZyMHZbD/as-02-(1).png' alt='Logo Principal' class="h-10 w-auto object-contain">
                </a>
                <div class="h-8 w-px bg-gray-200 mx-2"></div>
                <h1 class="text-xl font-bold text-gray-700 ml-4 tracking-tight">
                    Controle de Estoque
                </h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <a href="https://thamirisbezerra-coder.github.io/ControleAlmoxarifados/" target="_blank" 
                   class="text-blue-600 hover:text-blue-800 text-xs font-bold uppercase tracking-wider flex items-center bg-blue-50 px-4 py-2 rounded-full border border-blue-100 hover:bg-blue-100 transition-colors">
                    <ion-icon name="flask-outline" class="mr-2 text-lg"></ion-icon> Controle de MP
                </a>
            </div>
        </div>
    </header>

    <!-- NAVEGAÇÃO -->
    <div class="bg-gray-100/50 border-b border-gray-200 py-3 flex-shrink-0 backdrop-blur-sm">
        <div class="container mx-auto px-6">
            <nav class="flex space-x-2 overflow-x-auto pb-1 no-scrollbar" id="nav-tabs">
                <button data-warehouse="marketing" class="warehouse-tab bg-white text-blue-700 shadow-sm border border-gray-100 px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap cursor-pointer">Marketing</button>
                <button data-warehouse="rh" class="warehouse-tab text-gray-500 hover:text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap cursor-pointer">RH</button>
                <button data-warehouse="lacteos" class="warehouse-tab text-gray-500 hover:text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap cursor-pointer">Lácteos</button>
                <button data-warehouse="aromas" class="warehouse-tab text-gray-500 hover:text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap cursor-pointer">Aromas</button>
                <button data-warehouse="sorvetes" class="warehouse-tab text-gray-500 hover:text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap cursor-pointer">Sorvetes</button>
                <div class="w-px bg-gray-300 mx-2 h-6 self-center"></div>
                <button data-warehouse="relatorio" class="warehouse-tab text-gray-500 hover:text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap cursor-pointer flex items-center">
                    <ion-icon name="document-text-outline" class="mr-1"></ion-icon> Relatório
                </button>
            </nav>
        </div>
    </div>

    <!-- CONTEÚDO PRINCIPAL -->
    <main class="flex-grow container mx-auto px-6 py-6 overflow-hidden flex flex-col relative z-0">
        
        <!-- Orientações (Expansível) -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6 flex-shrink-0 overflow-hidden">
            <button id="help-toggle" class="w-full flex justify-between items-center px-5 py-3 text-left focus:outline-none hover:bg-gray-50 transition-colors group">
                <span class="font-semibold text-gray-700 text-sm flex items-center">
                    <div class="bg-blue-100 text-blue-600 p-1 rounded mr-3 group-hover:bg-blue-200 transition-colors">
                        <ion-icon name="bulb-outline"></ion-icon>
                    </div>
                    Orientações Rápidas
                </span>
                <ion-icon name="chevron-down-outline" class="text-gray-400 transition-transform duration-300"></ion-icon>
            </button>
            <div id="help-content" class="hidden px-5 pb-5 text-sm text-gray-600 bg-gray-50/50 border-t border-gray-100 pt-3">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="flex items-start"><ion-icon name="navigate-circle-outline" class="mr-2 mt-0.5 text-blue-500"></ion-icon><span>Navegue pelas abas superiores para acessar o estoque de cada setor.</span></div>
                    <div class="flex items-start"><ion-icon name="hand-left-outline" class="mr-2 mt-0.5 text-blue-500"></ion-icon><span>Selecione um item na lista e clique em <strong>Retirar</strong> para registrar saídas.</span></div>
                    <div class="flex items-start"><ion-icon name="calendar-number-outline" class="mr-2 mt-0.5 text-blue-500"></ion-icon><span>Para <strong>Empréstimos</strong>, não esqueça de definir a data de devolução.</span></div>
                </div>
            </div>
        </div>

        <!-- ÁREA DO ESTOQUE (Grid Principal) -->
        <div id="main-content" class="flex flex-grow gap-6 overflow-hidden h-full pb-2">
            <!-- Lista de Itens -->
            <div class="w-1/3 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col h-full overflow-hidden">
                <div class="p-4 border-b border-gray-100 bg-gray-50">
                    <div class="relative group">
                        <ion-icon name="search-outline" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-blue-500 transition-colors"></ion-icon>
                        <input type="text" id="search-bar" placeholder="Buscar por nome ou código..." 
                            class="w-full pl-10 pr-4 py-2.5 text-sm bg-white border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-400 outline-none transition-all placeholder-gray-400">
                    </div>
                </div>
                <div id="item-list" class="flex-grow overflow-y-auto custom-scrollbar bg-white">
                    <!-- Itens serão renderizados aqui -->
                </div>
                <div class="p-2 text-center text-[10px] text-gray-400 border-t border-gray-100 bg-gray-50">
                    Total de itens carregados
                </div>
            </div>

            <!-- Detalhes do Item -->
            <div id="item-details" class="w-2/3 bg-white rounded-xl shadow-sm border border-gray-200 p-6 h-full overflow-y-auto custom-scrollbar">
                <!-- Detalhes serão renderizados aqui -->
            </div>
        </div>

        <!-- ÁREA DO RELATÓRIO -->
        <div id="report-area" class="hidden flex-grow bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <div>
                    <h2 class="font-bold text-gray-800 text-lg">Histórico de Movimentações</h2>
                    <p class="text-xs text-gray-500">Registro completo de consumo e empréstimos</p>
                </div>
                <button onclick="window.print()" class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 transition-colors flex items-center shadow-sm">
                    <ion-icon name="print-outline" class="mr-2"></ion-icon> Imprimir Relatório
                </button>
            </div>
            <div class="flex-grow overflow-auto custom-scrollbar">
                <table class="w-full text-left">
                    <thead class="bg-gray-100/80 text-gray-600 sticky top-0 uppercase text-[11px] font-bold tracking-wider backdrop-blur-sm z-10 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-4">Data</th>
                            <th class="px-6 py-4">Solicitante / Setor</th>
                            <th class="px-6 py-4">Item</th>
                            <th class="px-6 py-4">Tipo</th>
                            <th class="px-6 py-4">Quantidade</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawal-history-table-body" class="divide-y divide-gray-50 bg-white">
                        <!-- Histórico via JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- RODAPÉ FIXO (Novo) -->
    <footer class="bg-white border-t border-gray-200 py-2 flex-shrink-0 z-10 shadow-[0_-2px_10px_rgba(0,0,0,0.02)]">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <div class="flex flex-col">
                <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Controle Interno</span>
                <span class="text-[10px] text-gray-400">Versão 3.0 • Sistema de Gestão</span>
            </div>
            <!-- Ícone/Desenho solicitado no rodapé -->
            <a href='https://postimages.org/' target='_blank' class="opacity-80 hover:opacity-100 transition-opacity transform hover:scale-105 duration-200">
                <img src='https://i.postimg.cc/wB4TvRM0/5164023.png' border='0' alt='Mascote do Sistema' class="h-8 w-auto">
            </a>
        </div>
    </footer>

    <!-- NOTIFICAÇÕES -->
    <div id="notification-container" class="fixed top-24 right-6 z-50 flex flex-col items-end pointer-events-none child:pointer-events-auto"></div>

    <!-- MODAL RETIRADA -->
    <div id="withdraw-stock-modal" class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity">
        <div id="withdraw-modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-95 opacity-0 overflow-hidden border border-gray-100">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 flex justify-between items-center text-white">
                <div class="flex items-center">
                    <ion-icon name="cart-outline" class="text-xl mr-2"></ion-icon>
                    <h3 class="font-bold text-lg">Nova Retirada</h3>
                </div>
                <button onclick="closeWithdrawModal()" class="text-white/70 hover:text-white hover:bg-white/20 rounded-full p-1 transition-all">
                    <ion-icon name="close" class="text-xl"></ion-icon>
                </button>
            </div>
            
            <form id="withdraw-stock-form" onsubmit="handleSubmitWithdraw(event)" class="p-6 space-y-5">
                <input type="hidden" id="withdraw-item-codigo">
                
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs text-blue-500 font-bold uppercase tracking-wide mb-1">Item Selecionado</div>
                            <div class="font-bold text-gray-800 text-lg leading-tight" id="withdraw-item-name">--</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-blue-400 mb-1">Disponível</div>
                            <span class="font-bold text-blue-700 text-xl font-mono-numbers" id="withdraw-current-stock">--</span>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5 ml-1">Quem está retirando?</label>
                    <div class="relative">
                        <ion-icon name="person-outline" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></ion-icon>
                        <input type="text" id="withdraw-name" required class="w-full border border-gray-300 rounded-lg pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="Nome do solicitante">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5 ml-1">Quantidade</label>
                    <div class="flex shadow-sm rounded-lg">
                        <input type="number" id="withdraw-amount" step="0.01" min="0.01" required class="w-full border border-gray-300 rounded-l-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-mono-numbers" placeholder="0.00">
                        <span class="bg-gray-100 border border-l-0 border-gray-300 px-4 py-2.5 rounded-r-lg text-gray-600 font-bold text-sm flex items-center justify-center min-w-[3rem]" id="withdraw-unit-label">un</span>
                    </div>
                </div>

                <!-- Checkboxes Estilizados -->
                <div class="space-y-3 pt-2">
                    <label class="flex items-center space-x-3 cursor-pointer p-3 border border-gray-200 rounded-xl hover:bg-gray-50 transition-colors group">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="withdraw-outro-setor" class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-gray-300 transition-all checked:border-blue-500 checked:bg-blue-500">
                            <ion-icon name="checkmark" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white opacity-0 peer-checked:opacity-100 text-sm pointer-events-none"></ion-icon>
                        </div>
                        <span class="text-sm text-gray-700 font-medium flex-grow">Retirada para outro setor</span>
                        <ion-icon name="business-outline" class="text-gray-400 group-hover:text-blue-500"></ion-icon>
                    </label>
                    
                    <div id="campos-outro-setor" class="hidden pl-4 space-y-3 border-l-2 border-blue-100 ml-4 animate-fade-in">
                        <input type="text" id="withdraw-setor" placeholder="Qual o setor?" class="w-full border border-gray-200 rounded-lg px-4 py-2 text-sm focus:border-blue-400 outline-none">
                        <input type="text" id="withdraw-centro-custo" placeholder="Centro de Custo" class="w-full border border-gray-200 rounded-lg px-4 py-2 text-sm focus:border-blue-400 outline-none">
                    </div>

                    <label class="flex items-center space-x-3 cursor-pointer p-3 border border-gray-200 rounded-xl hover:bg-purple-50 hover:border-purple-200 transition-colors group">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="withdraw-emprestimo" class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-gray-300 transition-all checked:border-purple-500 checked:bg-purple-500">
                            <ion-icon name="checkmark" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white opacity-0 peer-checked:opacity-100 text-sm pointer-events-none"></ion-icon>
                        </div>
                        <span class="text-sm text-gray-700 font-medium flex-grow">Empréstimo (requer devolução)</span>
                        <ion-icon name="time-outline" class="text-gray-400 group-hover:text-purple-500"></ion-icon>
                    </label>

                    <div id="campo-devolucao" class="hidden pl-4 border-l-2 border-purple-200 ml-4 animate-fade-in">
                        <label class="block text-xs text-purple-700 font-bold mb-1">Data de Devolução</label>
                        <input type="date" id="withdraw-data-devolucao" class="w-full border border-purple-200 rounded-lg px-4 py-2 text-sm bg-purple-50 focus:ring-purple-500 outline-none text-purple-900">
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full bg-gray-900 hover:bg-black text-white font-bold py-3.5 rounded-xl shadow-lg hover:shadow-xl transition-all active:scale-[0.98] flex justify-center items-center">
                        Confirmar Retirada
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL COMPROVANTE -->
    <div id="receipt-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div id="receipt-modal-content" class="bg-white w-full max-w-sm rounded-none shadow-2xl overflow-hidden transform transition-all scale-95 opacity-0 relative">
            
            <!-- Efeito de papel rasgado no topo (visual CSS simples) -->
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-b from-gray-100 to-white"></div>

            <div class="p-8 text-center border-b-2 border-dashed border-gray-300">
                <img src='https://i.postimg.cc/MZyMHZbD/as-02-(1).png' alt="Logo" class="h-10 mx-auto mb-3 object-contain grayscale opacity-90">
                <h2 class="font-bold text-xl uppercase tracking-[0.2em] text-gray-800 mb-1">Comprovante</h2>
                <p class="text-[10px] text-gray-500 uppercase tracking-wider" id="receipt-date">--</p>
            </div>
            
            <div class="p-8 space-y-4 font-mono text-xs text-gray-600 leading-relaxed bg-[#fffdfa]">
                <div class="flex justify-between items-end"><dt class="font-bold uppercase">Solicitante</dt><dd class="text-sm text-gray-900 font-bold" id="receipt-requester">--</dd></div>
                <div class="flex justify-between items-end"><dt class="font-bold uppercase">Item</dt><dd class="text-right max-w-[60%] text-gray-900" id="receipt-item">--</dd></div>
                
                <div class="border-b-2 border-dashed border-gray-200 my-4"></div>
                
                <div class="flex justify-between"><dt>Operação</dt><dd class="uppercase" id="receipt-type">--</dd></div>
                <div class="flex justify-between items-center mt-2">
                    <dt class="font-bold text-gray-900 text-sm">QUANTIDADE</dt>
                    <dd class="text-xl font-bold text-black" id="receipt-qtd">--</dd>
                </div>
                <div class="flex justify-between mt-1"><dt>Saldo Atual</dt><dd id="receipt-rest">--</dd></div>
                
                <div id="receipt-extra" class="mt-4 pt-4 border-t-2 border-dashed border-gray-200"></div>
                
                <div class="mt-8 text-center">
                    <img src="https://i.postimg.cc/wB4TvRM0/5164023.png" class="h-6 mx-auto opacity-50 mb-2 grayscale">
                    <p class="text-[10px] text-gray-400">Documento gerado eletronicamente.</p>
                </div>
            </div>

            <div class="bg-gray-900 p-4 flex justify-between items-center no-print">
                <button onclick="closeReceipt()" class="text-gray-400 hover:text-white text-xs font-bold uppercase tracking-wider px-4">Fechar</button>
                <button onclick="window.print()" class="bg-white text-black px-6 py-2 rounded font-bold text-xs uppercase tracking-wider hover:bg-gray-200 transition-colors flex items-center">
                    <ion-icon name="print" class="mr-2"></ion-icon> Imprimir
                </button>
            </div>
        </div>
    </div>

</body>
</html>

